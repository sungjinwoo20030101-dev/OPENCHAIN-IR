<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenChain IR | Forensic Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .text-light { color: #fff !important; }
        .text-success { color: #10b981 !important; }
        .text-danger { color: #ef4444 !important; }
        .text-warning { color: #f59e0b !important; }
        .text-info { color: #06b6d4 !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-black border-bottom border-secondary mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">OPENCHAIN <span class="text-primary">IR</span></a>
            <span class="badge bg-secondary">v1.1 Advanced Audit</span>
        </div>
    </nav>

    <div class="container">
        <div class="card p-4">
            <form method="POST" action="/">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label text-muted">üîó Blockchain</label>
                        <select name="chain" class="form-control form-control-lg" id="chainSelector">
                            <optgroup label="‚úÖ EVM Chains (Etherscan V2 API - Single Endpoint)">
                                <option value="ethereum" {% if current_chain == 'ethereum' %}selected{% endif %}>Ethereum Mainnet (ETH)</option>
                                <option value="bsc" {% if current_chain == 'bsc' %}selected{% endif %}>BNB Smart Chain (BSC)</option>
                                <option value="polygon" {% if current_chain == 'polygon' %}selected{% endif %}>Polygon Mainnet (MATIC)</option>
                                <option value="optimism" {% if current_chain == 'optimism' %}selected{% endif %}>Optimism (OP)</option>
                                <option value="arbitrum" {% if current_chain == 'arbitrum' %}selected{% endif %}>Arbitrum One (ARB)</option>
                                <option value="base" {% if current_chain == 'base' %}selected{% endif %}>Base by Coinbase (BASE)</option>
                                <option value="avalanche" {% if current_chain == 'avalanche' %}selected{% endif %}>Avalanche C-Chain (AVAX)</option>
                                <option value="fantom" {% if current_chain == 'fantom' %}selected{% endif %}>Fantom (FTM)</option>
                                <option value="cronos" {% if current_chain == 'cronos' %}selected{% endif %}>Cronos (CRO)</option>
                                <option value="moonbeam" {% if current_chain == 'moonbeam' %}selected{% endif %}>Moonbeam (GLMR)</option>
                                <option value="gnosis" {% if current_chain == 'gnosis' %}selected{% endif %}>Gnosis/xDai (GNO)</option>
                                <option value="celo" {% if current_chain == 'celo' %}selected{% endif %}>Celo (CELO)</option>
                                <option value="blast" {% if current_chain == 'blast' %}selected{% endif %}>Blast (BLAST)</option>
                                <option value="linea" {% if current_chain == 'linea' %}selected{% endif %}>Linea (ETH)</option>
                            </optgroup>
                            <optgroup label="üß™ Testnets">
                                <option value="sepolia" {% if current_chain == 'sepolia' %}selected{% endif %}>Sepolia Testnet (ETH)</option>
                            </optgroup>
                        </select>
                        <small class="text-muted d-block mt-1">üí° All chains use one API key from Etherscan.io</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted">üìç Address</label>
                        <input type="text" name="address" class="form-control form-control-lg" placeholder="0x... / 0x1f9840a85... / rN7n7otQDd..." required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-muted">Start Date</label>
                        <input type="date" name="start_date" class="form-control form-control-lg">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-muted">End Date</label>
                        <input type="date" name="end_date" class="form-control form-control-lg">
                    </div>
                    <div class="col-12">
                        <div class="form-check form-check-inline mt-2">
                            <input class="form-check-input" type="checkbox" id="include_internal" name="include_internal" {% if fetch_options.include_internal %}checked{% endif %}>
                            <label class="form-check-label text-muted" for="include_internal">Include Internal TXs</label>
                        </div>
                        <div class="form-check form-check-inline mt-2">
                            <input class="form-check-input" type="checkbox" id="include_token_transfers" name="include_token_transfers" {% if fetch_options.include_token_transfers %}checked{% endif %}>
                            <label class="form-check-label text-muted" for="include_token_transfers">Include Token Transfers</label>
                        </div>
                    </div>
                    <div class="col-12 d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">üîç Analyze Blockchain Data</button>
                    </div>
                </div>
            </form>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'warning' }} text-center">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if summary %}
        <div class="card">
            <div class="card-header border-bottom border-secondary">
                <ul class="nav nav-tabs card-header-tabs" id="irTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab">1. Overview</a></li>
                    <li class="nav-item"><a class="nav-link" id="charts-tab" data-bs-toggle="tab" href="#charts" role="tab">2. Charts</a></li>
                    <li class="nav-item"><a class="nav-link" id="clustering-tab" data-bs-toggle="tab" href="#clustering" role="tab">üï∏Ô∏è Clustering</a></li>
                    <li class="nav-item"><a class="nav-link" id="threat-tab" data-bs-toggle="tab" href="#threat" role="tab">üö® Threat Intel</a></li>
                    <li class="nav-item"><a class="nav-link" id="anomalies-tab" data-bs-toggle="tab" href="#anomalies" role="tab">ü§ñ Anomalies</a></li>
                    <li class="nav-item"><a class="nav-link" id="evidence-tab" data-bs-toggle="tab" href="#evidence" role="tab">3. Evidence</a></li>
                    <li class="nav-item"><a class="nav-link" id="report-tab" data-bs-toggle="tab" href="#report" role="tab">4. Report</a></li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content" id="irTabsContent">
                    
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="card-title text-light">Metric Summary</h4>
                            <div>
                                <span class="badge bg-info me-2">üîó {{ summary.chain_name|upper if summary.chain_name else 'Ethereum' }} (Chain ID: {{ summary.chain_id if summary.chain_id else '1' }})</span>
                                <span class="badge bg-secondary me-2">Transactions: {{ summary.total_transactions }}</span>
                                <span class="badge {{ 'bg-success' if 'Live' in source else 'bg-danger' }} fs-6">{{ source }}</span>
                            </div>
                        </div>
                        {% if tx_counts %}
                        <div class="mb-3">
                            <span class="badge bg-info me-2">Normal: {{ tx_counts.normal }}</span>
                            <span class="badge bg-secondary me-2">Internal: {{ tx_counts.internal }}</span>
                            <span class="badge bg-warning text-dark">Token: {{ tx_counts.token }}</span>
                        </div>
                        {% endif %}
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <div class="stat-val text-success">+{{ "%.2f"|format(summary.total_volume_in) }}</div>
                                    <div class="stat-label">Total Inflow</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <div class="stat-val text-danger">-{{ "%.2f"|format(summary.total_volume_out) }}</div>
                                    <div class="stat-label">Total Outflow</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-box">
                                    <div class="stat-val {{ 'text-success' if summary.net_flow > 0 else 'text-danger' }}">{{ "%.2f"|format(summary.net_flow) }}</div>
                                    <div class="stat-label">Net Flow</div>
                                </div>
                            </div>
                        </div>

                        {% if summary.cash_out_points %}
                        <div class="alert alert-danger mt-4">
                            <strong>‚ö†Ô∏è SUSPICIOUS ACTIVITY DETECTED:</strong>
                            <ul class="mb-0 mt-2">
                                {% for alert in summary.cash_out_points %}
                                    {% if alert is string %}
                                        <li>{{ alert }}</li>
                                    {% else %}
                                        <li>{{ alert.amount|default('Unknown') }} ETH ‚Üí {{ alert.name|default('Unknown Entity') }} ({{ alert.type|default('Unknown') }})</li>
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- PATTERNS SECTION -->
                        {% if summary.patterns %}
                        <div class="alert alert-warning mt-4">
                            <strong>üîç DETECTED PATTERNS:</strong>
                            <div class="mt-2">
                                {% set pattern_descriptions = {
                                    'rapid_succession': 'Rapid Succession - Multiple transactions within 60 seconds (structuring indicator)',
                                    'high_frequency_wallet': 'High Frequency Wallet - More than 50 transactions in period',
                                    'mixing_service_suspicion': 'Mixing Service Behavior - Many inputs consolidated into few outputs',
                                    'consolidation_pattern': 'Consolidation Pattern - Small inputs merged into large outputs (fund pooling)',
                                    'layering_pattern': 'Layering Pattern - Complex multi-hop transactions (AML obfuscation)',
                                    'dust_transactions': 'Dust Transactions - Very small transfers (<0.01 ETH)'
                                } %}
                                {% for pattern_name, pattern_data in summary.patterns.items() %}
                                    {% if pattern_data == True %}
                                        <p class="mb-2"><span class="badge bg-warning text-white">{{ pattern_descriptions.get(pattern_name, pattern_name|title) }}</span></p>
                                    {% elif pattern_data is iterable and pattern_data is not string %}
                                        {% if pattern_data|length > 0 %}
                                        <p class="mb-2"><span class="badge bg-warning text-white">{{ pattern_name|replace('_', ' ')|title }}: {{ pattern_data|length }} cases detected</span></p>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-success mt-4">
                            <strong>‚úì No suspicious patterns detected</strong>
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="charts" role="tabpanel">
                        <h4 class="card-title text-light mb-4">Entity Distribution</h4>
                        <div class="row justify-content-center">
                            <div class="col-md-6" style="height: 300px;">
                                <canvas id="flowChart"></canvas>
                            </div>
                            <div class="col-md-6 d-flex align-items-center">
                                <p class="text-muted">
                                    This chart visualizes the ratio of incoming vs. outgoing connections. 
                                    High "Senders" = Collection/Mixing Wallet.
                                    High "Receivers" = Distribution/Payment Wallet.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- CLUSTERING TAB (#2) -->
                    <div class="tab-pane fade" id="clustering" role="tabpanel">
                        <h4 class="card-title text-light mb-4">üï∏Ô∏è Cross-Address Clustering</h4>
                        
                        {% if clustering_results %}
                            {% if clustering_results.suspicious_counterparties %}
                            <div class="alert alert-warning mb-3">
                                <h6>Frequent Counterparties</h6>
                                <p class="text-white mb-0">Addresses with multiple interactions (potential related wallets)</p>
                                {% for cp in clustering_results.suspicious_counterparties[:10] %}
                                    <small class="d-block text-white">
                                        <span class="font-monospace">{{ cp.address[:16] }}...</span> 
                                        (Risk: {{ "%.1f"|format(cp.risk_score * 100) }}%)
                                    </small>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if clustering_results.dust_attacks %}
                            <div class="alert alert-danger mb-3">
                                <h6>Dust Attack Detection</h6>
                                <p class="text-white mb-0">Small amounts sent to many addresses (marker for address testing)</p>
                                {% for dust in clustering_results.dust_attacks[:5] %}
                                    <small class="d-block text-white">{{ dust.address[:16] }}... - Risk: {{ "%.0f"|format(dust.risk_score * 100) }}%</small>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if clustering_results.timing_clusters %}
                            <div class="alert alert-info mb-3">
                                <h6>Timing Clusters</h6>
                                <p class="text-white mb-0">Transactions bunched together (bot/mixer activity)</p>
                                {% for tc in clustering_results.timing_clusters[:5] %}
                                    <small class="d-block text-white">Cluster: {{ tc.cluster_size }} txs - Risk: {{ "%.0f"|format(tc.risk_score * 100) }}%</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No clustering patterns detected yet.</p>
                        {% endif %}
                    </div>

                    <!-- THREAT INTEL TAB (#7) -->
                    <div class="tab-pane fade" id="threat" role="tabpanel">
                        <h4 class="card-title text-light mb-4">üö® Threat Intelligence</h4>
                        
                        {% if threat_intel and threat_intel.is_flagged %}
                            <div class="alert alert-danger">
                                <h5 class="text-white">‚ö†Ô∏è ADDRESS FLAGGED IN THREAT DATABASE</h5>
                                <p class="mb-2"><strong>Severity:</strong> <span class="badge bg-danger">{{ threat_intel.severity|upper }}</span></p>
                                <p class="mb-2"><strong>Confidence:</strong> {{ "%.0f"|format(threat_intel.confidence * 100) }}%</p>
                                <p class="mb-0"><strong>Sources:</strong> 
                                    {% for source in threat_intel.threat_sources %}
                                        <span class="badge bg-warning text-dark">{{ source }}</span>
                                    {% endfor %}
                                </p>
                                <hr>
                                <p class="mb-0"><strong>Threat Types:</strong>
                                    {% for ttype in threat_intel.threat_types %}
                                        <span class="badge bg-danger">{{ ttype }}</span>
                                    {% endfor %}
                                </p>
                            </div>
                        {% else %}
                            <div class="alert alert-success">
                                <p class="mb-0">‚úì Address NOT found in threat databases (Chainalysis, OFAC, ScamAlert)</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- ANOMALIES TAB (#9) -->
                    <div class="tab-pane fade" id="anomalies" role="tabpanel">
                        <h4 class="card-title text-light mb-4">ü§ñ ML Anomaly Detection</h4>
                        
                        {% if anomalies and anomalies|length > 0 %}
                            <p class="text-muted mb-3">{{ anomalies|length }} anomalous transactions detected using Isolation Forest ML model</p>
                            <div class="table-responsive">
                                <table class="table table-dark table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>TX Hash</th>
                                            <th>Amount</th>
                                            <th>Anomaly Score</th>
                                            <th>Reasons</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for anom in anomalies[:20] %}
                                        <tr class="{% if anom.is_suspicious %}table-danger{% endif %}">
                                            <td><small class="font-monospace text-warning">{{ anom.hash[:16] }}...</small></td>
                                            <td>{{ "%.4f"|format(anom.amount) }}</td>
                                            <td>
                                                <span class="badge {% if anom.anomaly_score > 0.8 %}bg-danger{% elif anom.anomaly_score > 0.5 %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                                    {{ "%.2f"|format(anom.anomaly_score) }}
                                                </span>
                                            </td>
                                            <td><small>{% for reason in anom.reasons %}{{ reason }}<br>{% endfor %}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <p class="mb-0">‚úì No anomalies detected. Transaction patterns are normal.</p>
                                <small class="text-muted">ML anomaly detection requires sufficient data to establish baseline patterns.</small>
                            </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="evidence" role="tabpanel">
                        <h4 class="card-title text-light mb-4">Digital Artifacts & Evidence</h4>
                        
                        <!-- Transaction Graph -->
                        <div class="alert alert-info mb-4">
                            <h6>üìä Transaction Network Graph (GEXF Format)</h6>
                            <p class="mb-2">Compatible with Gephi (ForceAtlas2 Layout for visualization)</p>
                            <form action="/downloads/graph.gexf" method="GET" style="display: inline;">
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="downloadGexf()">
                                    üì• Download Network Graph (.GEXF)
                                </button>
                            </form>
                        </div>

                        <!-- Victims List -->
                        <h5 class="text-light mt-4 mb-3">üë• Source Addresses (Victims/Senders)</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped table-sm">
                                <thead class="bg-success bg-opacity-25">
                                    <tr>
                                        <th>Address</th>
                                        <th class="text-end">Amount Sent (ETH)</th>
                                        <th class="text-end">TX Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if summary.top_victims %}
                                        {% for addr, amount in summary.top_victims[:10] %}
                                            <tr>
                                                <td>
                                                    <small class="text-info font-monospace">
                                                        {{ addr[:16] }}...{{ addr[-8:] }}
                                                    </small>
                                                </td>
                                                <td class="text-end text-success">{{ "%.4f"|format(amount) }}</td>
                                                <td class="text-end">-</td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="3" class="text-muted text-center">No incoming transactions</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Suspects List -->
                        <h5 class="text-light mt-4 mb-3">‚ö†Ô∏è Destination Addresses (Suspects/Receivers)</h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped table-sm">
                                <thead class="bg-danger bg-opacity-25">
                                    <tr>
                                        <th>Address</th>
                                        <th class="text-end">Amount Received (ETH)</th>
                                        <th class="text-end">TX Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if summary.top_suspects %}
                                        {% for addr, amount in summary.top_suspects[:10] %}
                                            <tr>
                                                <td>
                                                    <small class="text-warning font-monospace">
                                                        {{ addr[:16] }}...{{ addr[-8:] }}
                                                    </small>
                                                </td>
                                                <td class="text-end text-danger">{{ "%.4f"|format(amount) }}</td>
                                                <td class="text-end">-</td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="3" class="text-muted text-center">No outgoing transactions</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Transaction Flow Diagram -->
                        <h5 class="text-light mt-4 mb-3">üîÑ Transaction Flow & Suspect Chain</h5>
                        <div class="alert alert-dark border border-secondary p-4" style="overflow-x: auto;">
                            <div style="font-family: monospace; line-height: 2; font-size: 0.9rem;">
                                <div class="mb-3">
                                    <span class="badge bg-success">VICTIMS (SOURCES)</span>
                                    <span style="color: #aaa;">‚Üì Send ETH ‚Üì</span>
                                </div>
                                <div style="background: #252525; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #0d6efd;">
                                    <strong style="color: #0d6efd;">TARGET ADDRESS (PRIMARY ACCOUNT)</strong>
                                    <br/>
                                    <small style="color: #aaa;">{{ summary.get('target_address', 'Analysis Address') }}</small>
                                </div>
                                <div class="mb-3">
                                    <span style="color: #aaa;">‚Üì Forward to ‚Üì</span>
                                    <span class="badge bg-danger">SUSPECTS (DESTINATIONS)</span>
                                </div>
                                {% if summary.top_suspects %}
                                    {% for addr, amount in summary.top_suspects[:3] %}
                                        <div style="background: #2d2d2d; padding: 10px; margin-bottom: 10px; border-radius: 3px; border-left: 3px solid #dc3545;">
                                            <small style="color: #dc3545;">{{ addr[:20] }}...</small>
                                            <small style="color: #888;">{{ "%.4f"|format(amount) }} ETH</small>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                {% if summary.cash_out_points %}
                                    <div class="mt-3">
                                        <span style="color: #aaa;">‚Üì Potential Cash-Out Points ‚Üì</span>
                                        <span class="badge bg-warning text-dark">EXCHANGES</span>
                                    </div>
                                    {% for point in summary.cash_out_points[:2] %}
                                        <div style="background: #332200; padding: 10px; margin-top: 10px; border-radius: 3px; border-left: 3px solid #ffc107;">
                                            <small style="color: #ffc107;">{{ point }}</small>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <!-- Patterns -->
                        {% if summary.patterns_detected %}
                        <h5 class="text-light mt-4 mb-3">üö® Suspicious Patterns Detected</h5>
                        <div class="alert alert-warning text-dark">
                            {% for pattern in summary.patterns_detected %}
                                <span class="badge bg-warning text-dark me-2">{{ pattern|upper }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="report" role="tabpanel">
                        <div class="text-center py-4">
                            <h4 class="text-light">üìä Advanced Forensic Tools</h4>
                            <p class="text-muted mb-4">Generate visualizations, legal reports, and analysis</p>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <form action="/report" method="POST">
                                        <button type="submit" class="btn btn-primary btn-lg w-100">
                                            üìÑ Forensic Report (PDF)
                                        </button>
                                    </form>
                                </div>

                                <div class="col-md-6">
                                    <form action="/timeline" method="POST">
                                        <button type="submit" class="btn btn-info btn-lg w-100">
                                            üìà Timeline Visualization
                                        </button>
                                    </form>
                                </div>

                                <div class="col-md-6">
                                    <form action="/sankey" method="POST">
                                        <button type="submit" class="btn btn-success btn-lg w-100">
                                            üí∞ Sankey Diagram
                                        </button>
                                    </form>
                                </div>

                                <div class="col-md-6">
                                    <form action="/heatmap" method="POST">
                                        <button type="submit" class="btn btn-warning btn-lg w-100">
                                            üî• Activity Heatmap
                                        </button>
                                    </form>
                                </div>

                                <div class="col-md-6">
                                    <form action="/legal_report" method="POST">
                                        <button type="submit" class="btn btn-danger btn-lg w-100" onclick="return promptLegalDetails()">
                                            ‚öñÔ∏è FIR Legal Report
                                        </button>
                                    </form>
                                </div>

                                <div class="col-md-6">
                                    <button type="button" class="btn btn-secondary btn-lg w-100" onclick="showCaseManager()">
                                        üìÅ Case Management
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function promptLegalDetails() {
            const investigator = prompt("Enter investigator name:", "Officer Name");
            if (!investigator) return false;
            
            const department = prompt("Enter department:", "Cybercrime Division");
            if (!department) return false;
            
            const caseId = prompt("Enter case ID:", "2024001");
            if (!caseId) return false;
            
            // Create hidden form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/legal_report';
            
            const invInput = document.createElement('input');
            invInput.type = 'hidden';
            invInput.name = 'investigator';
            invInput.value = investigator;
            
            const deptInput = document.createElement('input');
            deptInput.type = 'hidden';
            deptInput.name = 'department';
            deptInput.value = department;
            
            const caseInput = document.createElement('input');
            caseInput.type = 'hidden';
            caseInput.name = 'case_id';
            caseInput.value = caseId;
            
            form.appendChild(invInput);
            form.appendChild(deptInput);
            form.appendChild(caseInput);
            
            document.body.appendChild(form);
            form.submit();
            return false;
        }

        function showCaseManager() {
            alert('Case Management features:\n\n1. Create a new case\n2. Add addresses to case\n3. Track investigation notes\n\nFeature coming in next update with dedicated UI');
        }

        function downloadGexf() {
            window.location.href = '/downloads/graph.gexf';
        }
    </script>
    
    {% if summary %}
    <script>
        const ctx = document.getElementById('flowChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Unique Senders (In)', 'Unique Receivers (Out)'],
                datasets: [{
                    data: [{{ summary.unique_senders }}, {{ summary.unique_receivers }}],
                    backgroundColor: ['#198754', '#dc3545'],
                    borderColor: '#1e1e1e',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#aaa' } }
                }
            }
        });
    </script>
    {% endif %}
</body>
</html>